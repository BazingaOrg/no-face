# ğŸ¥ Real-time Camera & Recording Specification / å®æ—¶æ‘„åƒå¤´ä¸å½•åˆ¶è§„èŒƒ

## Overview / æ¦‚è¿°

Provide a privacy-preserving live camera mode that mirrors the existing image workflow while unlocking real-time emoji masking and optional recording. æ‰€æœ‰å¤„ç†ç»§ç»­åœ¨æµè§ˆå™¨æœ¬åœ°æ‰§è¡Œï¼Œéµå¾ªå½“å‰éšç§å®šä½ã€‚

## Feature Goals / åŠŸèƒ½ç›®æ ‡

- Deliver a front-facing and rear-facing camera experience with instant emoji overlays powered by `@vladmandic/face-api`.
- Preserve existing emoji editing semantics: per-face adjustmentsã€å…¨å±€è®¾ç½®å’Œé»˜è®¤è¡¨æƒ…åº”ä¿æŒä¸€è‡´çš„äº¤äº’ä¸è§†è§‰è¯­è¨€ã€‚
- Offer one-tap snapshot export å¤ç”¨ç°æœ‰ PNG å¯¼å‡ºæµç¨‹ï¼Œå¹¶åœ¨åç»­é˜¶æ®µæ”¯æŒè§†é¢‘å½•åˆ¶ã€‚
- Keep latency < 150 ms on ä¸»æµæ¡Œé¢ä¸ç§»åŠ¨è®¾å¤‡ï¼Œç¡®ä¿ UI æµç•…å¯ç”¨ã€‚

## Architecture / æ¶æ„è®¾è®¡

### Media Access Layer / åª’ä½“è®¿é—®å±‚

- Use `navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })` è¯·æ±‚å‰ç½®æ‘„åƒå¤´ï¼›åœ¨å¤±è´¥æˆ–ç”¨æˆ·åˆ‡æ¢æ—¶ fallback åˆ° `{ facingMode: { exact: 'environment' } }`ã€‚
- æš´éœ² Promise é£æ ¼ APIï¼Œè¿”å› `MediaStream`ã€å½“å‰æ¨¡å¼ï¼ˆå‰ç½®/åç½®ï¼‰ä»¥åŠ revoke æ–¹æ³•ï¼Œä¾¿äºçŠ¶æ€æœºç®¡ç†ã€‚
- æ‰€æœ‰æƒé™ç”³è¯·éœ€åœ¨ç”¨æˆ·æ‰‹åŠ¿è§¦å‘çš„å›è°ƒä¸­æ‰§è¡Œï¼›åœ¨ HTTP ç¯å¢ƒä¸‹é˜»æ­¢è¿›å…¥å®æ—¶æ¨¡å¼å¹¶æç¤ºå‡çº§åˆ° HTTPS æˆ– localhostã€‚

### Rendering Pipeline / æ¸²æŸ“ç®¡çº¿

- åœ¨å®æ—¶æ¨¡å¼å…¥å£ä¸­æŒ‚è½½ `HTMLVideoElement`ï¼Œä½¿ç”¨éšè— Canvas åŒæ­¥ç»˜åˆ¶è§†é¢‘å¸§ã€‚
- å°†ç°æœ‰ emoji å åŠ é€»è¾‘æŠ½è±¡ä¸ºå¯æ³¨å…¥çš„æ¸²æŸ“å±‚ï¼Œä¿è¯ Canvas å¯¼å‡ºçš„å›¾åƒä¸ç”¨æˆ·å¯è§ç”»é¢ä¸€è‡´ã€‚
- Detection loop é€šè¿‡ `requestAnimationFrame` æˆ–å›ºå®šæ—¶é—´ç‰‡æ‰§è¡Œï¼Œç»“åˆæŒ‡æ•°å¹³æ»‘/å¡å°”æ›¼æ»¤æ³¢å‡å°‘æŠ–åŠ¨ï¼›åœ¨ä½ç«¯è®¾å¤‡ä¸Šå…è®¸é™è‡³ 24 fpsã€‚
- ç»„ä»¶å¸è½½æˆ–æ¨¡å¼åˆ‡æ¢æ—¶å¿…é¡»è°ƒç”¨ `MediaStreamTrack.stop()`ï¼Œå¹¶é”€æ¯æ£€æµ‹å¾ªç¯ä»¥é‡Šæ”¾èµ„æºã€‚

### State Machine / çŠ¶æ€æœº

- `idle â†’ requesting-permission â†’ initializing â†’ streaming â†’ paused â†’ error`ã€‚
- æ¯ä¸ªçŠ¶æ€å¯¹åº” UI æç¤ºä¸æ“ä½œæŒ‰é’®ï¼ˆä¾‹å¦‚åœ¨ `error` çŠ¶æ€æä¾›é‡è¯•ä¸å›é€€åˆ°å›¾ç‰‡æ¨¡å¼ï¼‰ã€‚
- åœ¨ `streaming` çŠ¶æ€æ”¯æŒ `pause`ï¼ˆå†»ç»“æ£€æµ‹ä½†ä¿ç•™æœ€åä¸€å¸§ï¼‰ä¸ `resume` è¡Œä¸ºã€‚

## UX & UI Guidelines / äº¤äº’ä¸ç•Œé¢æŒ‡å¼•

- åœ¨é¦–é¡µæˆ–ä¸Šä¼ é¢æ¿ä¸­æä¾›â€œå®æ—¶æ¨¡å¼â€æŒ‰é’®ï¼Œè§†è§‰æƒé‡ä¸â€œä¸Šä¼ å›¾ç‰‡â€ç›¸å½“ã€‚
- å®æ—¶æ¨¡å¼å¸ƒå±€ï¼šé¡¶éƒ¨è§†é¢‘åŒºåŸŸ + emoji å åŠ å±‚ï¼›åº•éƒ¨ä¿æŒ emoji é€‰æ‹©å™¨ä¸ inspectorï¼Œæ¡Œé¢ç«¯å¯ç§»è‡³ä¾§æ ã€‚
- æƒé™ç”³è¯·å¤±è´¥ã€æ‘„åƒå¤´ç¼ºå¤±ã€Safari æ‰‹åŠ¿é™åˆ¶ç­‰åœºæ™¯éœ€å¼¹å‡ºå†…è”æç¤ºï¼Œå¹¶å¼•å¯¼å›é™æ€å›¾ç‰‡æ¨¡å¼ã€‚
- æ·»åŠ æ˜æ˜¾çš„â€œæ‹ç…§â€æŒ‰é’®ï¼Œç‚¹å‡»åå†»ç»“å½“å‰å¸§å¹¶è¿›å…¥å¯¼å‡ºå¯¹è¯æ¡†ï¼›åŒæ—¶æä¾›â€œç»§ç»­å®æ—¶â€å…¥å£ã€‚
- UI ä¸­æä¾›æ€§èƒ½æŒ‡ç¤ºï¼ˆå¦‚è½»é‡çº§ FPS æˆ–â€œæ€§èƒ½ä¼˜å…ˆ/è´¨é‡ä¼˜å…ˆâ€å¼€å…³ï¼‰ã€‚

## Video Recording Extension / è§†é¢‘å½•åˆ¶æ‰©å±•

- å½•åˆ¶å‰åœ¨å®æ—¶æ¨¡å¼ä¸­å¯¹ Canvas è¿›è¡Œåˆæˆï¼›è°ƒç”¨ `canvas.captureStream(targetFps)` è·å–è§†é¢‘è½¨é“ã€‚
- ä½¿ç”¨ `MediaRecorder` å½•åˆ¶ WebMï¼ˆé»˜è®¤ï¼‰æˆ– MP4ï¼ˆSafari â‰¥ 14.5ï¼‰ï¼Œåœ¨ä¸æ”¯æŒç›®æ ‡ MIME æ—¶å›é€€åˆ°æç¤ºã€‚
- å¯é€‰éŸ³é¢‘è½¨é“ï¼šè‹¥ç”¨æˆ·åŒæ„éº¦å…‹é£æƒé™ï¼Œå°† `MediaStream` åˆå¹¶ï¼›å¦åˆ™æä¾›é™éŸ³æç¤ºå¹¶ä»…å½•åˆ¶ç”»é¢ã€‚
- ä¸ºä½ç«¯è®¾å¤‡æš´éœ²åˆ†è¾¨ç‡/å¸§ç‡è®¾ç½®ï¼ˆ1080pã€720pã€480pï¼‰ï¼Œå¹¶è®°å½•é»˜è®¤ç­–ç•¥ï¼ˆæ ¹æ®ç¡¬ä»¶èƒ½åŠ›æˆ–æ‰‹åŠ¨é€‰æ‹©ï¼‰ã€‚
- å½•åˆ¶ UIï¼šåˆ‡æ¢æŒ‰é’®ï¼ˆå¼€å§‹/åœæ­¢ï¼‰ã€è®¡æ—¶å™¨æ˜¾ç¤ºã€å½•åˆ¶çŠ¶æ€æŒ‡ç¤ºï¼ˆFramer Motion åŠ¨ç”»ï¼‰ã€‚
- å¯¼å‡ºç­–ç•¥ï¼šç”Ÿæˆ Blob åè§¦å‘ä¸‹è½½ï¼Œå‘½ååŒ…å«æ—¶é—´æˆ³ï¼›åœ¨ Safari ä¸Šæç¤ºç”¨æˆ·ä½¿ç”¨ Files åº”ç”¨ä¿å­˜ã€‚

## Compatibility Matrix / å…¼å®¹æ€§çŸ©é˜µ

- âœ… Chromium æ¡Œé¢ (Chrome 109+ / Edge 109+): æ”¯æŒå‰åæ‘„åƒã€WebM å½•åˆ¶ã€‚
- âœ… Firefox 108+: æ”¯æŒæ‘„åƒå¤´ä¸ WebM å½•åˆ¶ï¼Œéœ€æµ‹è¯•é•¿æœŸå½•åˆ¶ç¨³å®šæ€§ã€‚
- âœ… Safari macOS 14+ / iOS 15.2+: æ”¯æŒ H.264/HEVC å½•åˆ¶ï¼Œå¿…é¡»åœ¨ HTTPS ä¸ç”¨æˆ·æ‰‹åŠ¿è§¦å‘ä¸‹å·¥ä½œã€‚
- âš ï¸ Android ä½ç«¯è®¾å¤‡ï¼šå»ºè®®é»˜è®¤å¯ç”¨ Tiny Face Detector ä¸ 720p@24fps ä»¥é™ä½åŠŸè€—ã€‚
- âŒ Internet Explorer / æ—§ç‰ˆæµè§ˆå™¨ï¼šä¸æ”¯æŒ `getUserMedia`ï¼Œä¿æŒé™æ€ä¸Šä¼ æ¨¡å¼ã€‚

## Risks & Mitigations / é£é™©ä¸ç¼“è§£

- é¦–æ¬¡åŠ è½½æ¨¡å‹å¯èƒ½å­˜åœ¨ 2-3 ç§’å»¶è¿Ÿï¼šè¿›å…¥å®æ—¶æ¨¡å¼å‰é¢„åŠ è½½æˆ–æç¤ºç”¨æˆ·ç­‰å¾…ã€‚
- ä½å…‰ç¯å¢ƒæ£€æµ‹ç‡ä¸‹é™ï¼šå»ºè®®åŠ å…¥æç¤ºæˆ–æŒ‡å¯¼ç”¨æˆ·å¢åŠ å…‰çº¿ï¼Œå¹¶åœ¨æ–‡æ¡£ä¸­è®°å½•æœ€ä½³å®è·µã€‚
- å¤šè®¾å¤‡å…¼å®¹å·®å¼‚ï¼šæ–°å¢ Cypress æˆ– Playwright å†’çƒŸè„šæœ¬æ—¶éœ€è¦†ç›–æƒé™æµç¨‹ï¼Œå½“å‰é˜¶æ®µè‡³å°‘æ‰‹åŠ¨éªŒè¯ã€‚
- é•¿æ—¶é—´å½•åˆ¶å¯¼è‡´å†…å­˜å ç”¨ä¸Šå‡ï¼šåˆ†æ®µä¿å­˜ Blob æˆ–æç¤ºç”¨æˆ·é™åˆ¶å½•åˆ¶æ—¶é•¿ã€‚

## Open Questions / å¾…ç¡®è®¤äº‹é¡¹

- æ˜¯å¦éœ€è¦ä¸ºå®æ—¶æ¨¡å¼æä¾›åå°è¿è¡Œé™åˆ¶ï¼ˆåˆ‡æ¢æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨æš‚åœï¼‰ã€‚
- Web Worker + OffscreenCanvas æå‰æŠ•å…¥çš„ä¼˜å…ˆçº§ã€‚
- å½•åˆ¶æ–‡ä»¶å¤§å°ä¸Šé™ä¸è‡ªåŠ¨æ¸…ç†ç­–ç•¥ã€‚
